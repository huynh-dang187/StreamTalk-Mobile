<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Web Chat (Robust)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #login-screen { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        #chat-screen { width: 450px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; display: none; flex-direction: column; height: 85vh; }
        .chat-header { background: #6200EE; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9; }
        .message-bubble { max-width: 75%; padding: 10px; border-radius: 10px; margin-bottom: 10px; word-wrap: break-word; }
        .my-message { align-self: flex-end; background-color: #6200EE; color: white; margin-left: auto; }
        .other-message { align-self: flex-start; background-color: #E0E0E0; color: #333; }
        .input-area { padding: 10px; display: flex; border-top: 1px solid #eee; }
        
        /* Video Call UI */
        #video-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .video-container { display: flex; gap: 20px; justify-content: center; align-items: center; flex-wrap: wrap; }
        #local-video { width: 150px; height: 100px; background: #333; border: 2px solid #6200EE; transform: scaleX(-1); object-fit: cover; }
        #remote-video { width: 100%; max-width: 500px; height: auto; background: black; border: 2px solid white; }
        .status-text { color: white; margin-bottom: 10px; font-weight: bold; }

        /* Incoming Call Popup */
        #incoming-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        .incoming-content { background: white; padding: 30px; border-radius: 15px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color: #6200EE;">üëã Web Client</h2>
        <input type="text" id="login-input" placeholder="Nh·∫≠p t√™n..." style="padding: 10px; margin-bottom: 10px; width: 200px;">
        <br>
        <button onclick="joinChat()" style="padding: 10px 20px; background: #6200EE; color: white; border: none; cursor: pointer;">Tham Gia</button>
    </div>

    <div id="chat-screen">
        <div class="chat-header">
            <span>üí¨ Ph√≤ng Chat</span>
            <button onclick="startCall()" style="background: none; border: 1px solid white; color: white; cursor: pointer;">üìπ G·ªçi Video</button>
        </div>
        <div id="chat-box"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Tin nh·∫Øn..." style="flex: 1; padding: 10px;">
            <button onclick="sendMessage()" style="padding: 10px; background: #6200EE; color: white; border: none;">G·ª≠i</button>
        </div>
    </div>

    <div id="incoming-modal">
        <div class="incoming-content">
            <h3>üìû C√≥ cu·ªôc g·ªçi ƒë·∫øn!</h3>
            <button onclick="rejectCall()" style="background: red; color: white; padding: 10px 20px; border: none; margin: 5px;">T·ª´ ch·ªëi</button>
            <button onclick="acceptCall()" style="background: green; color: white; padding: 10px 20px; border: none; margin: 5px;">Tr·∫£ l·ªùi</button>
        </div>
    </div>

    <div id="video-screen">
        <div class="status-text" id="call-status">ƒêang k·∫øt n·ªëi...</div>
        <div class="video-container">
            <video id="local-video" autoplay playsinline muted></video>
            <video id="remote-video" autoplay playsinline></video>
        </div>
        <button onclick="closeVideo()" style="background: red; color: white; padding: 10px 30px; border: none; margin-top: 20px; border-radius: 20px; cursor: pointer;">‚ùå K·∫øt th√∫c</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        const socket = io();
        let myName = ""; 
        let localStream = null;
        let peerConnection = null;
        let pendingOffer = null;
        let iceCandidateQueue = []; 

        const rtcConfig = { 
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ] 
        };

        // --- 1. X·ª¨ L√ù MEDIA (Camera/Mic) ---
        async function getMediaStream() {
            try {
                // Th·ª≠ l·∫•y c·∫£ Video v√† Audio
                console.log("üìπ ƒêang th·ª≠ m·ªü Camera & Mic...");
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            } catch (err) {
                console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Camera ho·∫∑c b·ªã t·ª´ ch·ªëi:", err);
                try {
                    // N·∫øu l·ªói, th·ª≠ ch·ªâ l·∫•y Audio (Mic)
                    console.log("üé§ ƒêang th·ª≠ m·ªü Mic (Ch·∫ø ƒë·ªô Audio-Only)...");
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (err2) {
                    console.error("‚ùå Kh√¥ng c√≥ thi·∫øt b·ªã n√†o (Mic/Cam). Ch·∫ø ƒë·ªô Ch·ªâ Xem.", err2);
                    localStream = null; // V·∫´n ti·∫øp t·ª•c ch·∫°y ƒë·ªÉ xem h√¨nh b√™n kia
                }
            }

            if (localStream) {
                document.getElementById('local-video').srcObject = localStream;
            }
        }

        // --- 2. WEBRTC CORE ---
        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);

            // G·ª≠i Candidate sang Mobile
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log("üì§ G·ª≠i Candidate:", event.candidate.candidate);
                    socket.emit("candidate", {
                        sdpMid: event.candidate.sdpMid,
                        sdpMLineIndex: event.candidate.sdpMLineIndex,
                        candidate: event.candidate.candidate
                    });
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                const status = document.getElementById('call-status');
                status.innerText = `Tr·∫°ng th√°i: ${peerConnection.iceConnectionState}`;
                console.log("‚ùÑÔ∏è ICE State:", peerConnection.iceConnectionState);
            };

            // Nh·∫≠n Video t·ª´ Mobile
            peerConnection.ontrack = (event) => {
                console.log("üåä Nh·∫≠n ƒë∆∞·ª£c Stream t·ª´ Mobile!");
                const remoteVideo = document.getElementById('remote-video');
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // Add lu·ªìng c·ªßa m√¨nh v√†o (n·∫øu c√≥)
            if (localStream) {
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            } else {
                // N·∫øu PC kh√¥ng c√≥ cam/mic, ta t·∫°o m·ªôt "Offer" ch·ªâ nh·∫≠n (recvonly) ƒë·ªÉ b√°o Mobile g·ª≠i h√¨nh sang
                if (peerConnection.addTransceiver) {
                    peerConnection.addTransceiver('video', { direction: 'recvonly' });
                    peerConnection.addTransceiver('audio', { direction: 'recvonly' });
                }
            }
        }

        // --- 3. QUY TR√åNH G·ªåI ---
        
        // A. G·ªçi ƒëi (T·ª´ Web)
        async function startCall() {
            document.getElementById('video-screen').style.display = 'flex';
            await getMediaStream();
            await createPeerConnection();

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', offer);
        }

        // B. Nh·∫≠n cu·ªôc g·ªçi (T·ª´ Mobile)
        socket.on('offer', (offer) => {
            console.log("üîî C√≥ cu·ªôc g·ªçi ƒë·∫øn...");
            pendingOffer = offer;
            document.getElementById('incoming-modal').style.display = 'flex';
        });

        async function acceptCall() {
            document.getElementById('incoming-modal').style.display = 'none';
            document.getElementById('video-screen').style.display = 'flex';
            
            await getMediaStream();
            await createPeerConnection();

            await peerConnection.setRemoteDescription(new RTCSessionDescription(pendingOffer));
            processIceQueue(); // N·∫°p candidate ƒë√£ ch·ªù

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', answer);
            pendingOffer = null;
        }

        // C. X·ª≠ l√Ω t√≠n hi·ªáu
        socket.on('answer', async (answer) => {
            if (!peerConnection) return;
            console.log("üì• Nh·∫≠n Answer");
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            processIceQueue();
        });

        socket.on('candidate', async (candidateData) => {
            const candidate = new RTCIceCandidate(candidateData);
            if (peerConnection && peerConnection.remoteDescription) {
                try { await peerConnection.addIceCandidate(candidate); } catch(e){}
            } else {
                iceCandidateQueue.push(candidate);
            }
        });

        async function processIceQueue() {
            while (iceCandidateQueue.length > 0) {
                try { await peerConnection.addIceCandidate(iceCandidateQueue.shift()); } catch(e){}
            }
        }

        function rejectCall() { document.getElementById('incoming-modal').style.display = 'none'; }
        
        function closeVideo() {
            document.getElementById('video-screen').style.display = 'none';
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            if (peerConnection) { peerConnection.close(); peerConnection = null; }
            location.reload();
        }

        // --- 4. CHAT C∆† B·∫¢N ---
        function joinChat() {
            myName = document.getElementById('login-input').value.trim() || "WebUser";
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
        }
        function sendMessage() {
            const input = document.getElementById('msg-input');
            if (input.value) {
                socket.emit('chat_message', { user: myName, content: input.value });
                input.value = "";
            }
        }
        socket.on('chat_message', (data) => {
            const div = document.createElement('div');
            div.className = "message-bubble " + (data.user === myName ? "my-message" : "other-message");
            div.innerText = (data.user === myName ? "" : data.user + ": ") + data.content;
            document.getElementById('chat-box').appendChild(div);
        });
    </script>
</body>
</html>