<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myName = localStorage.getItem('chat_username') || "";
    let myID = localStorage.getItem('buddy_id') || "";
    let myAvatar = localStorage.getItem('my_avatar') || 1;
    let myFriends = JSON.parse(localStorage.getItem('my_friends')) || [];
    let onlineUsers = [];
    let pendingRequest = null;
    let currentChatID = null;

    // --- DATA ---
    const vocabList = [ { word: "Serendipity", mean: "Sá»± tÃ¬nh cá» may máº¯n", ph: "/ËŒser.É™nËˆdÉªp.É™.ti/" }, { word: "Resilience", mean: "Kháº£ nÄƒng phá»¥c há»“i", ph: "/rÉªËˆzÉªl.jÉ™ns/" }, { word: "Ebullience", mean: "Sá»± sÃ´i ná»•i", ph: "/ÉªËˆbÊŠl.i.É™ns/" } ];
    function initRandomWord() { const rand = vocabList[Math.floor(Math.random()*vocabList.length)]; document.getElementById('wotd-word').innerText = rand.word; document.getElementById('wotd-mean').innerText = rand.ph + " â€¢ " + rand.mean; document.getElementById('wotd-icon').innerText = rand.word.charAt(0); }
    function playWordAudio() { const u = new SpeechSynthesisUtterance(document.getElementById('wotd-word').innerText); u.lang = 'en-US'; speechSynthesis.speak(u); }

    // --- SOCKET EVENTS ---
    socket.on('online_users', u => { onlineUsers = u; if(document.getElementById('buddy-screen').classList.contains('active')) renderBuds('all'); });
    socket.on('incoming_friend_request', u => { pendingRequest=u; document.getElementById('req-name').innerText=u.username; document.getElementById('req-mod').style.display='flex'; });
    socket.on('friend_request_accepted', u => { addF(u); showT(`${u.username} Ä‘Ã£ cháº¥p nháº­n!`); });
    socket.on('request_failed', msg => { showT(msg); });
    socket.on('request_sent_success', msg => { showT(msg); });
    
    socket.on('private_message', data => {
        saveChat(data.from, { ...data, type: data.type, user: 'theirs' });
        if (currentChatID === data.from) appendMsg(data, 'theirs');
        else { showRedDot(true); showT(`Tin nháº¯n má»›i tá»« ${data.user}`); }
    });

    // --- CHAT PERSISTENCE ---
    function saveChat(friendID, msgData) {
        let chatKey = `chat_${myID}_${friendID}`;
        let history = JSON.parse(localStorage.getItem(chatKey)) || [];
        history.push(msgData);
        localStorage.setItem(chatKey, JSON.stringify(history));
    }

    function loadChat(friendID) {
        let chatKey = `chat_${myID}_${friendID}`;
        let history = JSON.parse(localStorage.getItem(chatKey)) || [];
        document.getElementById('msgs').innerHTML = '';
        history.forEach(msg => appendMsg(msg, msg.user === 'mine' ? 'mine' : 'theirs'));
    }

    // --- UI LOGIC ---
    function showRedDot(show) { document.querySelectorAll('.red-dot').forEach(el => el.style.display = show ? 'block' : 'none'); }
    
    function openChat(id, name, avatar) { 
        currentChatID = id; 
        document.getElementById('chat-name').innerText = name; 
        document.getElementById('chat-avatar').src = `https://i.pravatar.cc/150?img=${avatar || 1}`;
        loadChat(id);
        switchScreen('chat-ui'); 
        showRedDot(false); 
    }

    function sendMsg() { 
        const inp = document.getElementById('c-inp'); const content = inp.value.trim(); 
        if(content && currentChatID) { 
            const msgData = { to: currentChatID, content, type: 'text', user: myName };
            socket.emit('private_message', msgData); 
            const savedMsg = { content, type: 'text', user: 'mine' };
            saveChat(currentChatID, savedMsg);
            appendMsg(savedMsg, 'mine'); 
            inp.value = ""; 
        } 
    }
    
    function fileUp(inp) {
        const f = inp.files[0];
        if(f && currentChatID) {
            const r = new FileReader();
            r.onload = e => {
                const type = f.type.startsWith('image/') ? 'image' : 'file';
                const msgData = { to: currentChatID, type: type, fileData: e.target.result, fileName: f.name, user: myName };
                socket.emit('private_message', msgData);
                const savedMsg = { type: type, fileData: e.target.result, fileName: f.name, user: 'mine' };
                saveChat(currentChatID, savedMsg);
                appendMsg(savedMsg, 'mine');
            };
            r.readAsDataURL(f); inp.value = "";
        }
    }

    function appendMsg(data, type) {
        const div = document.createElement('div'); div.className = `msg ${type}`;
        if(data.type === 'file') div.innerHTML = `<a href="${data.fileData}" download="${data.fileName}" class="f-card">ðŸ“Ž ${data.fileName}</a>`;
        else if(data.type === 'image') div.innerHTML = `<img src="${data.fileData}" class="m-img">`;
        else div.innerText = data.content;
        const area = document.getElementById('msgs'); area.appendChild(div); area.scrollTop = area.scrollHeight;
    }

    // --- VIDEO CALL LOGIC (ÄÃƒ Sá»¬A Lá»–I) ---
    
    // 1. HÃ m khá»Ÿi táº¡o Media (CÃ³ xá»­ lÃ½ tá»« chá»‘i quyá»n)
    async function setupMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('loc-vid').srcObject = localStream;
            return true; // ThÃ nh cÃ´ng
        } catch (e) {
            alert("Lá»—i: Báº¡n Ä‘Ã£ cháº·n Camera/Mic. Vui lÃ²ng báº­t quyá»n truy cáº­p trong cÃ i Ä‘áº·t trÃ¬nh duyá»‡t!");
            document.getElementById('vid-mod').style.display = 'none';
            return false; // Tháº¥t báº¡i
        }
    }

    // 2. Báº¯t Ä‘áº§u cuá»™c gá»i
    async function startCall() {
        if (!myFriends.some(f => f.id == currentChatID)) { 
            showT("Chá»‰ gá»i cho báº¡n bÃ¨!"); return; 
        }
        
        document.getElementById('vid-mod').style.display = 'block'; 
        
        // Chá» láº¥y quyá»n Camera xong má»›i gá»i
        const mediaReady = await setupMedia();
        if (mediaReady) {
            createPeer();
            peerConnection.createOffer().then(o => {
                peerConnection.setLocalDescription(o);
                socket.emit('video_offer', { to: currentChatID, offer: o });
            });
        }
    }

    // 3. Xá»­ lÃ½ khi bá»‹ tá»« chá»‘i (User A nháº­n tin tá»« B)
    socket.on('video_reject', () => {
        endCall(); // Tá»± táº¯t mÃ n hÃ¬nh gá»i
        showT("NgÆ°á»i nháº­n Ä‘ang báº­n!");
    });

    // 4. CÃ¡c sá»± kiá»‡n WebRTC khÃ¡c
    socket.on('video_offer', d => { 
        if(d.from) { 
            pendingOffer = d.offer; 
            currentChatID = d.from; // LÆ°u ID ngÆ°á»i gá»i Ä‘á»ƒ tráº£ lá»i
            document.getElementById('inc-call').style.display = 'block'; 
        } 
    });
    socket.on('video_answer', d => { if(peerConnection) peerConnection.setRemoteDescription(d.answer); });
    socket.on('video_candidate', d => { if(peerConnection) peerConnection.addIceCandidate(d.candidate); });

    // 5. User B báº¥m tá»« chá»‘i
    function rejCall() {
        document.getElementById('inc-call').style.display = 'none';
        // Gá»­i thÃ´ng bÃ¡o tá»« chá»‘i cho ngÆ°á»i gá»i (currentChatID lÃ  ngÆ°á»i gá»i)
        socket.emit('video_reject', { to: currentChatID });
    }

    // 6. User B báº¥m nghe
    async function accCall() {
        document.getElementById('inc-call').style.display = 'none';
        document.getElementById('vid-mod').style.display = 'block';
        
        const mediaReady = await setupMedia();
        if (mediaReady) {
            createPeer();
            await peerConnection.setRemoteDescription(pendingOffer);
            const a = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(a);
            socket.emit('video_answer', { to: currentChatID, answer: a });
        }
    }

    // 7. Káº¿t thÃºc cuá»™c gá»i
    function endCall() {
        document.getElementById('vid-mod').style.display = 'none';
        if (localStream) localStream.getTracks().forEach(t => t.stop());
        if (peerConnection) peerConnection.close();
        switchScreen('sum-scr'); // Hiá»‡n mÃ n hÃ¬nh tá»•ng káº¿t
    }

    let peerConnection, localStream; 
    const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    
    function createPeer() {
        peerConnection = new RTCPeerConnection(rtcConfig);
        if (localStream) localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
        peerConnection.ontrack = e => document.getElementById('rem-vid').srcObject = e.streams[0];
        peerConnection.onicecandidate = e => e.candidate && socket.emit('video_candidate', { to: currentChatID, candidate: e.candidate });
    }

    // --- UTILS ---
    function switchScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
    function goToTab(t){
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(t==='home'){switchScreen('home-screen');document.querySelectorAll('.bottom-nav .nav-item:nth-child(1)').forEach(n=>n.classList.add('active')); initRandomWord();}
        if(t==='topics'){switchScreen('topic-screen');document.querySelectorAll('.bottom-nav .nav-item:nth-child(2)').forEach(n=>n.classList.add('active'));}
        if(t==='buddies'){renderBuds('all');switchScreen('buddy-screen');document.querySelectorAll('.bottom-nav .nav-item:nth-child(3)').forEach(n=>n.classList.add('active'));}
        if(t==='profile'){switchScreen('profile-screen');document.querySelectorAll('.bottom-nav .nav-item:nth-child(4)').forEach(n=>n.classList.add('active'));}
    }
    function showT(m){const t=document.getElementById("toast");t.innerText=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000);}
    function showAdd(){document.getElementById('add-mod').style.display='flex';document.getElementById('fid-inp').value='';}
    function sendReq(){
        const id=document.getElementById('fid-inp').value; 
        if(!id) { showT("Vui lÃ²ng nháº­p ID!"); return; }
        if(id == myID) { showT("KhÃ´ng thá»ƒ káº¿t báº¡n vá»›i chÃ­nh mÃ¬nh!"); return; }
        if(myFriends.some(f => f.id == id)) { showT("ÄÃ£ lÃ  báº¡n bÃ¨ rá»“i!"); return; }
        socket.emit('send_friend_request',{toId:id,fromUser:{id:myID,username:myName,avatar:myAvatar}});
        document.getElementById('add-mod').style.display='none';
    }
    function accReq(){if(pendingRequest){addF(pendingRequest);socket.emit('accept_friend_request',{toId:pendingRequest.id,fromUser:{id:myID,username:myName,avatar:myAvatar}});document.getElementById('req-mod').style.display='none';}}
    
    function addF(u){
        if(myFriends.some(f=>f.id==u.id))return;
        const newFriend = { ...u, avatar: u.avatar || 1 }; 
        myFriends.push(newFriend);
        localStorage.setItem('my_friends',JSON.stringify(myFriends));
        if(document.getElementById('buddy-screen').classList.contains('active'))renderBuds('all');
    }

    function renderBuds(){
        const c=document.getElementById('bud-list');c.innerHTML='';
        if(myFriends.length===0) c.innerHTML='<p style="text-align:center;color:#888;margin-top:20px;">ChÆ°a cÃ³ báº¡n.</p>';
        myFriends.forEach(b=>{
            const on=onlineUsers.some(u=>u.id==b.id);
            c.innerHTML+=`<div class="bud-card"><img src="https://i.pravatar.cc/150?img=${b.avatar}" class="b-avt"><div style="flex:1;"><b style="font-size:15px;">${b.username||b.name}</b><br><small style="color:${on?'green':'#aaa'}">${on?'âš¡ Online':'Offline'}</small><div style="font-size:10px;color:#888;">ID: ${b.id}</div></div><span class="material-icons-outlined" onclick="openChat('${b.id}','${b.username||b.name}', ${b.avatar})" style="padding:10px;cursor:pointer;">chat_bubble_outline</span></div>`;
        });
    }
    
    function showError(msg) { const el = document.getElementById('login-msg'); el.innerText = msg; setTimeout(() => el.innerText = "", 3000); }
    let isReg=false;
    function toggleRegisterMode(){isReg=!isReg;document.getElementById('form-title').innerText=isReg?"ÄÄƒng kÃ½":"BuddySpeak";document.getElementById('auth-btn').innerText=isReg?"ÄÄƒng kÃ½":"ÄÄƒng nháº­p";document.getElementById('toggle-text').innerText=isReg?"ÄÃ£ cÃ³ TK?":"ChÆ°a cÃ³ TK?";document.getElementById('toggle-btn').innerText=isReg?"ÄÄƒng nháº­p":"ÄÄƒng kÃ½";}
    async function handleLogin(){
        const u=document.getElementById('username').value,p=document.getElementById('password').value;
        if(!u||!p){ showError("Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin!"); return; }
        const url=isReg?'/api/register':'/api/login';
        try{const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});const d=await res.json();
        if(d.success){
            if(isReg){showError("ÄÄƒng kÃ½ thÃ nh cÃ´ng!"); document.getElementById('login-msg').style.color="green"; setTimeout(()=>{toggleRegisterMode(); document.getElementById('login-msg').style.color="red";},1500);}
            else{
                myName=d.username;myID=d.buddyId;myAvatar=d.avatar||1;
                localStorage.setItem('chat_username',myName);localStorage.setItem('buddy_id',myID);localStorage.setItem('my_avatar',myAvatar);
                socket.emit('register_user',{id:myID,username:myName,avatar:myAvatar});
                document.querySelectorAll('.d-name').forEach(e=>e.innerText=myName);document.getElementById('my-id').innerText=myID;document.getElementById('my-profile-pic').src=`https://i.pravatar.cc/150?img=${myAvatar}`;
                switchScreen('home-screen'); initRandomWord();
            }
        }else{showError(d.message);}}catch(e){showError("Lá»—i káº¿t ná»‘i Server!");}
    }
    function logout(){localStorage.clear();window.location.reload();}
    function copyID(){navigator.clipboard.writeText(myID);showT("ÄÃ£ sao chÃ©p ID!");}
    function selTop(t){const h={'Presentation':'Good morning...','Coffee':'Latte please'}[t]||"Hello";document.getElementById('match-txt').innerText="Chá»§ Ä‘á»: "+t;switchScreen('match-scr');setTimeout(()=>{goToTab('buddies')},2000);}

    if(myName&&myID){
        document.querySelectorAll('.d-name').forEach(e=>e.innerText=myName);
        document.getElementById('my-id').innerText=myID;
        document.getElementById('my-profile-pic').src=`https://i.pravatar.cc/150?img=${myAvatar}`;
        socket.emit('register_user',{id:myID,username:myName,avatar:myAvatar}); initRandomWord();
        switchScreen('home-screen');
    }
</script>
</body>
</html>